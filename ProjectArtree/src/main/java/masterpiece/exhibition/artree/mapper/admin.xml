<?xml version="1.0" encoding="UTF-8"?>

<!-- ====  mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="admin">

	<!-- tag 가져오기 - categories -->
	<select id="getTypes" resultType="String">
		select distinct type from tag
	</select>
	
	<!-- tag 가져오기 - keywords -->
	<select id="getKeywords" parameterType="String" resultType="String">
		select keyword from tag where type = #{ type }
	</select>
	
	<!-- gallery 가져오기 -->
	<select id="getGalleries" resultType="masterpiece.exhibition.admin.model.GalleryVO">
		select galleryno, location, galleryname, detailaddress, nvl(tel, '-') as tel from Gallery 
		where galleryname != '-'
		order by location, galleryname
	</select>
	
	<!-- gallery location 가져오기 -->
	<select id="getGalleryLocations" resultType="String">
		select distinct location from gallery where location != '-' order by location
	</select>
	
	<!-- gallery 검색 -->
	<select id="wordSearchShow" resultType="masterpiece.exhibition.admin.model.GalleryVO" parameterType="HashMap">
		select galleryno, location, galleryname, detailaddress, nvl(tel, '-') as tel from Gallery 
		where galleryname != '-'
		<if test='searchWord != "" , galleryLocation == ""'>	<!-- 지역을 선택하지 않고 검색어를 입력한 경우 -->
		    and galleryname like '%' || #{ searchWord } || '%' or detailaddress like '%' || #{ searchWord } || '%'
		</if>
		<if test='galleryLocation != "" , searchWord != ""'>	<!-- 지역을 선택하고 또 검색어를 입력한 경우 -->
			and location = #{ galleryLocation } 
			and galleryname like '%' || #{ searchWord } || '%'
		</if>
		<if test='searchWord == "" , galleryLocation == ""'>
		
		</if>
		order by location, galleryname
	</select>
	
	<select id="getApplyingno" resultType="int">
		select seq_appliedExhibits.nextval from dual
	</select>
	
	<insert id="addExhibition" parameterType="HashMap">
		insert into appliedExhibits ( applyingNo, fk_galleryNo, exhibitionName, applier, author, startDate, endDate,
			email, tel, genre, tag, authorInfo, exhibitionInfo, price, foodorDrink, extraRestriction, photo, openCloseTime )
		values ( #{ applyingno }, #{ fk_galleryno }, #{ exhibitionName }, #{ applier }, #{ author }, #{ startDate },
			#{ endDate }, #{ email }, #{ tel }, #{ genre }, #{ tag }, #{ authorInfo }, #{ exhibitionInfo }, #{ price }, #{ foodorDrink },
			#{ extraRestriction }, #{ photo }, #{ openCloseTime } )
	</insert>
	
	<insert id="addExhibitImage" parameterType="HashMap">
		insert into appliedDetail(appliedimgseq, fk_applyingNo, imagefilename, imageorgFilename, imagefileSize, imageInfo, thumbnailFileName) 
		values( seq_appliedDetail.nextval, #{ fk_applyingno }, #{ imagefilename },
			#{ imageorgfilename }, #{ imagefilesize }, #{ imageinfo }, #{ thumbnailfilename } )
	</insert>
	
	<!-- 전시회목록 가져오기 -->
	<select id="getExhibitionList" resultType="masterpiece.exhibition.exhibits.model.ExhibitsVO">
		select exhibitionno, exhibitionname, author, status from exhibition where status = '전시중'
	</select>
	
	<!-- 전시회정보 가져오기 -->
	<select id="getExhibitionDetail" resultType="masterpiece.exhibition.exhibits.model.ExhibitsVO" parameterType="String">
		select E.exhibitionno, E.exhibitionname, E.author, E.status, G.galleryname
			, E.applier, E.tel, E.email, E.startdate || ' - ' || E.enddate, E.genre, E.tag
			, E.exhibitioninfo, E.price, E.foodofdrink, E.extrarestriction, E.photo, E.openclosetime
		from exhibition E JOIN gallery G
		on E.fk_galleryno = G.galleryno
		where E.fk_galleryno = #{ no }
	</select>

</mapper>
